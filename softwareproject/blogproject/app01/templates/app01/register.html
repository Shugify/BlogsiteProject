<!DOCTYPE html>
<html lang="en">
<head>
	{% load static %}
<meta charset="utf-8"/>
<link rel="apple-touch-icon" sizes="76x76" href="{% static 'app01/image/favicon.ico' %}">
<link rel="icon" type="image/png" href="{% static 'app01/image/favicon.ico' %}">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
<title>Mundana Template by WowThemesNet</title>
<meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no' name='viewport'/>
<!-- Google Font -->
<link href="https://fonts.googleapis.com/css?family=Playfair+Display:400,700|Source+Sans+Pro:400,600,700" rel="stylesheet">
<!-- Font Awesome Icons -->
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">
<!-- Main CSS -->
<link href="{% static 'app01/css/main.css' %}" rel="stylesheet"/>

<style>

  .modal {
  position: fixed;
  z-index: 1;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  display: none; /* 使用 flexbox 布局 */
  align-items: center; /* 垂直居中 */
  justify-content: center; /* 水平居中 */
  background-color: rgba(0,0,0,0.4);
}

.modal-content {
  background-color: #fefefe;
  padding: 20px;
  border: 1px solid #888;
  width: 50%; /* 调整宽度 */
  max-width: 600px; /* 设置最大宽度 */
  height: auto; /* 自适应高度 */
  max-height: 80%; /* 设置最大高度 */
  text-align: center;
}


</style>

</head>
<body>

<!--------------------------------------
NAVBARMundana is an HTML Bootstrap Template for Professional Blogging
--------------------------------------->
<nav class="topnav navbar navbar-expand-lg navbar-light bg-white fixed-top">
<div class="container">
	<a class="navbar-brand font-weight-bold spanborder" ><span><strong>一串欢迎语？啥都不放的话有点空</strong></span></a>

       <ul class="navbar-nav ml-auto d-flex align-items-center">
			<li class="nav-item highlight">
			<a class="nav-link" href="http://127.0.0.1:8000/ad_login/">管理员登录</a>
			</li>
		</ul>
</div>

</nav>

<!-- End Navbar -->
    
  <div id="errorPopup" class="error-popup" style="display: none;"></div>
<!--------------------------------------
HEADER
--------------------------------------->
<div class="container">
	<div class="jumbotron jumbotron-fluid  pt-10 pb-10 bg-lightblue position-relative " style="background-size: cover">
		<div class="pl-4 pr-10 h-200 pt-10 pb-10 tofront">
        <div class="row justify-content-between">
            <div class="col-md-8 pt-4 pb-5 align-self-center">

				<h1 class="secondfont mb-3 font-weight-bold">欢迎进入BLOG</h1>

				 <form id="registerForm" action="{% url 'register' %}" method="post">
                    {% csrf_token %}
                            <div class="col-md-12 pt-5  align-self-center">
                                <label for="inputUsername">用户名:</label>

                                 <div class="row">
                                    <div class="col-md-8 pt-1  align-self-center">
                                        <input type="text" id="inputUsername" name="name" class="form-control" placeholder="Your name" onblur="judgeName()" required>
                                    </div>
                                    <div class="col-md-3 pt-1  align-self-center"><span id="vname"></span></div>

                                </div>
                            </div>



                            <div class="col-md-12 pt-1  align-self-center">
                                <label for="inputEmail">电子邮箱:</label>

                                <div class="row">
                                    <div class="col-md-8 pt-1  align-self-center">
                                        <input type="email" id="inputEmail" name="email" class="form-control" placeholder="Your email" onblur="judgeEmail()" required>
                                    </div>
                                    <div class="col-md-3 pt-1  align-self-center"><span id="vemail"></span></div>

                                </div>
                            </div>


                            <div class="col-md-12 pt-1  align-self-center">
                                <label for="inputphone">电话:</label>
                                <div class="row">
                                    <div class="col-md-8 pt-1  align-self-center">
                                        <input type="text" id="inputphone" name="phone" class="form-control" placeholder="Your phone number" onblur="judgePhone()" required>
                                    </div>
                                    <div class="col-md-3 pt-1  align-self-center"><span id="vphone"></span></div>

                                </div>

                            </div>



                            <div class="col-md-12 pt-1  align-self-center">
                                <label for="inputPassword">密码：</label>
                                <div class="row">
                                    <div class="col-md-8 pt-1  align-self-center">
                                        <input type="password" id="inputPassword" name="pwd" class="form-control" placeholder="Password" onblur="Password()"  required>
                                    </div>
                                    <div class="col-md-3 pt-1  align-self-center"><span id="vpwd"></span></div>

                                </div>
                            </div>



                            <div class="col-md-12 pt-1  align-self-center">
                                <label for="confirmPassword">确认密码：</label>
                                <div class="row">
                                    <div class="col-md-8 pt-1  align-self-center">
                                        <input type="password" id="confirmPassword" name="cpwd" class="form-control" placeholder="Confirm Password" onblur="validatePassword()" required>
                                    </div>
                                    <div class="col-md-3 pt-1  align-self-center"><span id="samepwd"></span></div>
                                </div>
                            </div>


                            <div class="col-md-12 pt-5 pb-2 align-self-center">
                                <button class="btn btn-dark" type="button" onclick="submitRegistrationForm()">注册</button>

                                <a href="http://127.0.0.1:8000/index/" class="custom-link" style="text-decoration: underline; margin-left: 20px; display: inline-block;">返回登录界面</a>
                            </div>
				</form>

            </div>

            <div class="col-md-4 d-none d-md-block " style="background-size: 100%,100%; background-image: url({% static 'app01/image/demo/home.jpg' %}) ;">
                <!-- 保留原有的背景图片设置 -->
            </div>


        </div>
    </div>
	</div>
</div>
<!-- End Header -->

<div id="successModal" class="modal" >
  <div class="modal-content">
    <p>注册成功！</p>
     <p id="registerId"></p>
    <p id="countdown"></p>

  </div>
</div>
    
<!--------------------------------------
MAIN
--------------------------------------->



<!--------------------------------------
FOOTER
--------------------------------------->
<div class="container mt-5">
	<footer class="bg-white border-top p-3 text-muted small">
	<div class="row align-items-center justify-content-between">
		<div>
            <span class="navbar-brand mr-2"><strong>五元一次方程组</strong></span> 倾情制作
			<script>document.write(new Date().getFullYear())</script>
			 . Open most copyright.
		</div>
		<div>
			点击 <a target="_blank" class="text-secondary font-weight-bold" href="https://github.com/Shugify/BlogsiteProject/">这里</a> 查看项目源码.
		</div>
	</div>
	</footer>
</div>
<!-- End Footer -->
    
<!--------------------------------------
JAVASCRIPTS
--------------------------------------->
<script src="{% static 'app01/js/vendor/jquery.min.js' %}" type="text/javascript"></script>
<script src="{% static 'app01/js/vendor/popper.min.js' %}" type="text/javascript"></script>
<script src="{% static 'app01/js/vendor/bootstrap.min.js' %}" type="text/javascript"></script>
<script src="{% static 'app01/js/functions.js' %}" type="text/javascript"></script>

<script>

    function isValidEmail(email) {
    // 正则表达式用于匹配邮箱格式
    var emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
    return emailPattern.test(email);
    }

    function judgeEmail(){
    var email = document.getElementById('inputEmail').value;
    if (email=="") {
        document.getElementById("vemail").style.color = "red"
        document.getElementById("vemail").innerHTML = "邮箱不能为空"
    }
    else if (!isValidEmail(email)) {
        document.getElementById("vemail").style.color = "red"
        document.getElementById("vemail").innerHTML = "邮箱格式错误"
    }
    else {
        document.getElementById("vemail").style.color = "green"
        document.getElementById("vemail").innerHTML = ""
    }
    }

     function judgePhone(){
    var phone = document.getElementById('inputphone').value;
    if (phone=="") {
        document.getElementById("vphone").style.color = "red"
        document.getElementById("vphone").innerHTML = "电话不能为空"
    }
    else if (phone.length<11) {
        document.getElementById("vphone").style.color = "red"
        document.getElementById("vphone").innerHTML = "电话格式错误"
    }
    else {
        document.getElementById("vphone").style.color = "green"
        document.getElementById("vphone").innerHTML = ""
    }


    }

    function validatePassword() {
    var password = document.getElementById('inputPassword').value;
    var confirmPassword = document.getElementById('confirmPassword').value;

     if (confirmPassword.length==0) {
        document.getElementById("samepwd").style.color = "red"
        document.getElementById("samepwd").innerHTML = "请输入密码"
    }
    else if (password !== confirmPassword) {
        document.getElementById("samepwd").style.color = "red"
        document.getElementById("samepwd").innerHTML = "两次密码不一致"
    }
    else {
        document.getElementById("samepwd").style.color = "green"
        document.getElementById("samepwd").innerHTML = "√"
    }
    }


    function isAllLetters(str) {
        return /^[a-zA-Z]+$/.test(str);}
    function isAllDigits(str) {
        return /^\d+$/.test(str);}


    function Password() {
    var password = document.getElementById('inputPassword').value;

    if (password.length<4) {
        document.getElementById("vpwd").style.color = "red"
        document.getElementById("vpwd").innerHTML = "密码长度不小于4"
    }
    else if(isAllDigits(password)){
        document.getElementById("vpwd").style.color = "red"
        document.getElementById("vpwd").innerHTML = "密码不能全为数字"
    }
    else if(isAllLetters(password)){
        document.getElementById("vpwd").style.color = "red"
        document.getElementById("vpwd").innerHTML = "密码不能全为字母"
    }
    else {
        document.getElementById("vpwd").style.color = "green"
        document.getElementById("vpwd").innerHTML = "√"
    }

    }

    function judgeName() {
    var name = document.getElementById('inputUsername').value;

    if (name=="") {
        document.getElementById("vname").style.color = "red"
        document.getElementById("vname").innerHTML = "名称不能为空"
    }
    else {
        document.getElementById("vname").style.color = "green"
        document.getElementById("vname").innerHTML = "√"
    }

    }



   function submitRegistrationForm() {
    var name = document.getElementById('inputUsername').value;
    var email = document.getElementById('inputEmail').value;
    var phone = document.getElementById('inputphone').value;
    var password = document.getElementById('inputPassword').value;
    var rpassword = document.getElementById('confirmPassword').value;
    var csrfToken = document.querySelector('input[name=csrfmiddlewaretoken]').value;

    var xhr = new XMLHttpRequest();
    xhr.open('POST', '/register/', true);
    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    xhr.setRequestHeader('X-CSRFToken', csrfToken);

    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            var response = JSON.parse(xhr.responseText);
            if (response.success) {
                // 注册成功，显示弹窗
                var modal = document.getElementById("successModal");
                var countdownElement = document.getElementById("countdown");
                var registerIdElement = document.getElementById("registerId");
                var newUserId = response.new_user_id;

                modal.style.display = "flex"; // 将弹窗显示
                // 使用以下代码设置弹窗居中
                modal.style.alignItems = "center"; // 垂直居中
                modal.style.justifyContent = "center"; // 水平居中


                var countdown = 5;
                var countdownInterval = setInterval(function() {
                    countdown--;
                    countdownElement.textContent = countdown + " 秒后跳转...";
                    if (countdown <= 0) {
                        clearInterval(countdownInterval);
                       window.location.href = '/index/?userid=' + newUserId;
                    }
                }, 1000);

                // 获取后端传递的新用户ID数据并显示在页面上
                registerIdElement.textContent = "您的用户ID：" + newUserId;

            } else {
                // 注册失败，设置错误信息
                if (response.error_type === 'invalid') {
                    alert(response.error);
                }

                if (response.error_type === 'invalid_form') {
                    alert(response.error);
                }

                if (response.error_type === 'email_exists') {
                    document.getElementById('vemail').style.color = "red";
                    document.getElementById('vemail').innerText = response.error;
                } else {
                    vemail.textContent = ""; // 清空错误信息
                }

                if (response.error_type === 'phone_exists') {
                    document.getElementById('vphone').style.color = "red";
                    document.getElementById('vphone').innerText = response.error;
                } else {
                    vphone.textContent = ""; // 清空错误信息
                }

                if (response.error_type === 'pwd_mismatch') {
                    document.getElementById('samepwd').style.color = "red";
                    document.getElementById('samepwd').innerText = response.error;
                }
            }
        }
    };

    var data = 'name=' + encodeURIComponent(name) + '&email=' + encodeURIComponent(email) + '&phone=' + encodeURIComponent(phone) + '&password=' + encodeURIComponent(password) + '&rpassword=' + encodeURIComponent(rpassword);
    xhr.send(data);
    }






</script>

</body>
</html>